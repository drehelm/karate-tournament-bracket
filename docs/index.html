<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tournament Bracket Generator</title>
  <!-- Inline script to check JavaScript -->
  <script>
    // This will replace the "JavaScript disabled" message if JS is working
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById('js-disabled-message').style.display = 'none';
      console.log("JavaScript is enabled and running!");
    });
  </script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1, h2, h3 {
      color: #1a73e8;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
      padding: 20px;
      background-color: #f5f5f5;
      border-radius: 8px;
    }
    
    .controls h2 {
      margin-top: 0;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .competitor-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
    }
    
    .competitor-entry {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .competitor-entry input {
      width: 40px;
      text-align: center;
    }
    
    .competitor-entry input[type="text"] {
      flex-grow: 1;
      width: auto;
      text-align: left;
    }
    
    button {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }
    
    button:hover {
      background-color: #1557b0;
    }
    
    .output {
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 8px;
      overflow-x: auto;
    }
    
    #diagram-container {
      overflow-x: auto;
      margin-top: 20px;
    }
    
    pre {
      white-space: pre-wrap;
      background-color: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    #js-disabled-message {
      background-color: #ffe0e0;
      color: #d00;
      padding: 20px;
      border-radius: 5px;
      border: 1px solid #fcc;
      text-align: center;
      margin: 20px 0;
    }
    
    .debug-info {
      background-color: #f5f5f5;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: monospace;
      display: none; /* Hidden by default */
    }
  </style>
</head>
<body>
  <h1>Tournament Bracket Generator</h1>

  <!-- Message that will be hidden if JavaScript works -->
  <div id="js-disabled-message">
    <h2>JavaScript Required</h2>
    <p>This application requires JavaScript to run. Please enable JavaScript in your browser settings and reload the page.</p>
    <p>If you're seeing this message and JavaScript is enabled, check the browser console for errors.</p>
  </div>
  
  <div class="container" id="app-container" style="display:none;">
    <div class="controls">
      <h2>Configure Tournament</h2>
      
      <div class="form-group">
        <label for="competitor-count">Number of Competitors (2-20):</label>
        <input type="number" id="competitor-count" min="2" max="20" value="8">
      </div>
      
      <div class="form-group">
        <label>
          <input type="checkbox" id="show-seeds" checked>
          Show seed numbers in brackets
        </label>
      </div>
      
      <div class="form-group">
        <label>Competitors:</label>
        <div id="competitor-list" class="competitor-list"></div>
      </div>
      
      <div class="form-group">
        <button id="generate-bracket">Generate Bracket</button>
      </div>
    </div>
    
    <div class="output">
      <h2>Generated Bracket</h2>
      <div id="diagram-container"></div>
      
      <h3>Mermaid Syntax</h3>
      <pre id="mermaid-output"></pre>
    </div>
    
    <div class="debug-info" id="debug-info">
      <h3>Debug Information</h3>
      <div id="debug-content"></div>
    </div>
  </div>

  <!-- Mermaid Script -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  
  <script>
    // Debug helper function
    function debug(message) {
      const debugInfo = document.getElementById('debug-content');
      const debugContainer = document.getElementById('debug-info');
      
      if (debugInfo && debugContainer) {
        debugContainer.style.display = 'block';
        debugInfo.innerHTML += `<div>${message}</div>`;
      }
      console.log(message);
    }
    
    // Check if Mermaid loaded
    if (typeof mermaid === 'undefined') {
      debug("Mermaid library failed to load");
    } else {
      debug("Mermaid library loaded successfully");
    }
    
    // Tournament bracket code - all in one file
    
    /**
     * Validates the competitors array.
     */
    function validateCompetitors(competitors) {
      if (competitors.length > 20) {
        throw new RangeError("Division cap exceeded");
      }
      
      // Check if seeds are unique and in range 1...N
      const seeds = competitors.map(c => c.seed);
      const uniqueSeeds = new Set(seeds);
      
      if (uniqueSeeds.size !== competitors.length) {
        throw new TypeError("Seeds must be unique");
      }
      
      for (const seed of seeds) {
        if (!Number.isInteger(seed) || seed < 1 || seed > competitors.length) {
          throw new TypeError(`Seeds must be integers from 1 to ${competitors.length}`);
        }
      }
    }

    /**
     * Generates 32 slots with proper seeding, inserting BYEs where needed.
     */
    function generateSlots(competitors) {
      validateCompetitors(competitors);

      // Standard 32-slot balanced seeding (bit-reverse order)
      const seedOrder = [
        1, 32, 16, 17, 8, 25, 9, 24, 4, 29, 13, 20, 5, 28, 12, 21,
        2, 31, 15, 18, 7, 26, 10, 23, 3, 30, 14, 19, 6, 27, 11, 22
      ];
      
      // Create a map of seed -> competitor for quick lookup
      const competitorMap = new Map();
      competitors.forEach(c => competitorMap.set(c.seed, c));
      
      // Generate slots based on the seeding order
      const slots = seedOrder.map(seed => {
        if (seed > competitors.length) {
          // This is a BYE
          return { seed: null, name: null };
        } else {
          const competitor = competitorMap.get(seed);
          return { seed: competitor.seed, name: competitor.name };
        }
      });
      
      return slots;
    }

    /**
     * Generates a Mermaid diagram string for a tournament bracket.
     */
    function generateMermaidBracket(competitors, options) {
      if (!options) options = { showSeeds: true };
      
      validateCompetitors(competitors);
      const slots = generateSlots(competitors);
      
      let diagramStr = "flowchart LR\n";
      
      // Add styles for different node types
      diagramStr += "classDef competitor fill:#f9f9f9,stroke:#333,stroke-width:1px,rx:4px,ry:4px\n";
      diagramStr += "classDef bye fill:#f0f0f0,stroke:#999,stroke-width:1px,rx:4px,ry:4px,font-style:italic\n";
      diagramStr += "classDef full-bye fill:#f0f0f0,stroke:#999,stroke-width:1px,rx:4px,ry:4px,font-style:italic,stroke-dasharray:5,5\n";
      diagramStr += "classDef winner fill:#e6f7ff,stroke:#0066cc,stroke-width:2px,rx:4px,ry:4px,font-weight:bold\n";
      
      // Generate first round matches (16 matches, 32 slots)
      const matchCount = 16;
      const roundCount = 5; // log2(32) = 5 rounds
      
      // Create first round matches (R1)
      for (let i = 0; i < matchCount; i++) {
        const topSlot = slots[2 * i];
        const bottomSlot = slots[2 * i + 1];
        const matchId = `M${i + 1}`;
        
        // Format player labels with optional seeds
        const formatPlayer = (slot) => {
          if (slot.seed === null) return "BYE";
          return options.showSeeds ? `[${slot.seed}] ${slot.name}` : slot.name;
        };
        
        // Create match node - always create nodes for all matches
        diagramStr += `${matchId}["${formatPlayer(topSlot)}<hr/>${formatPlayer(bottomSlot)}"]\n`;
        
        // Apply style based on content
        if (topSlot.seed === null && bottomSlot.seed === null) {
          // Full BYE match (both sides are BYEs)
          diagramStr += `${matchId}:::full-bye\n`;
        } else if (topSlot.seed === null || bottomSlot.seed === null) {
          // Partial BYE (one side is a BYE)
          diagramStr += `${matchId}:::bye\n`;
        } else {
          // Regular match (both competitors)
          diagramStr += `${matchId}:::competitor\n`;
        }
      }
      
      // Create subsequent rounds (R2 to finals)
      // Each round has half the matches of the previous round
      for (let round = 2; round <= roundCount; round++) {
        const matchesInRound = matchCount / Math.pow(2, round - 1);
        
        for (let i = 0; i < matchesInRound; i++) {
          const matchId = `R${round}M${i + 1}`;
          const roundName = round === roundCount ? "Final" : `Round ${round}`;
          
          // Create match node for this round
          diagramStr += `${matchId}["${roundName}<hr/>Match ${i + 1}"]\n`;
          diagramStr += `${matchId}:::competitor\n`;
          
          // Connect to previous round matches
          const prevMatch1 = round === 2 ? `M${i*2 + 1}` : `R${round-1}M${i*2 + 1}`;
          const prevMatch2 = round === 2 ? `M${i*2 + 2}` : `R${round-1}M${i*2 + 2}`;
          
          // Connect all matches, regardless of bye status
          diagramStr += `${prevMatch1} --> ${matchId}\n`;
          diagramStr += `${prevMatch2} --> ${matchId}\n`;
        }
      }
      
      return diagramStr;
    }

    // Main app initialization - wrapped in a function to avoid global scope
    function initApp() {
      try {
        // Show app container, hide JavaScript disabled message
        document.getElementById('js-disabled-message').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        
        debug("Application initialized");
        
        // Initialize Mermaid
        mermaid.initialize({
          startOnLoad: true,
          theme: 'default',
          flowchart: {
            useMaxWidth: false,
            htmlLabels: true,
            curve: 'basis'
          },
          securityLevel: 'loose'
        });
        
        debug("Mermaid initialized");
        
        // Elements
        const competitorCountInput = document.getElementById('competitor-count');
        const showSeedsCheckbox = document.getElementById('show-seeds');
        const competitorListContainer = document.getElementById('competitor-list');
        const generateBracketButton = document.getElementById('generate-bracket');
        const diagramContainer = document.getElementById('diagram-container');
        const mermaidOutput = document.getElementById('mermaid-output');
        
        // Update competitor list when count changes
        competitorCountInput.addEventListener('change', updateCompetitorList);
        
        // Generate bracket when button is clicked
        generateBracketButton.addEventListener('click', generateBracketUI);
        
        // Initialize with default competitors
        updateCompetitorList();
        
        function updateCompetitorList() {
          try {
            const count = parseInt(competitorCountInput.value) || 8;
            competitorCountInput.value = Math.min(Math.max(count, 2), 20); // Enforce limits
            
            competitorListContainer.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
              const competitorEntry = document.createElement('div');
              competitorEntry.className = 'competitor-entry';
              
              const seedInput = document.createElement('input');
              seedInput.type = 'number';
              seedInput.min = '1';
              seedInput.max = count.toString();
              seedInput.value = (i + 1).toString();
              seedInput.id = `seed-${i}`;
              
              const nameInput = document.createElement('input');
              nameInput.type = 'text';
              nameInput.value = `Player ${i + 1}`;
              nameInput.id = `name-${i}`;
              
              competitorEntry.appendChild(seedInput);
              competitorEntry.appendChild(nameInput);
              competitorListContainer.appendChild(competitorEntry);
            }
            debug(`Created competitor list with ${count} entries`);
          } catch (error) {
            debug(`Error updating competitor list: ${error.message}`);
          }
        }
        
        function generateBracketUI() {
          try {
            debug("Generating bracket...");
            
            // Collect competitor data
            const count = parseInt(competitorCountInput.value);
            const competitors = [];
            
            for (let i = 0; i < count; i++) {
              const seedInput = document.getElementById(`seed-${i}`);
              const nameInput = document.getElementById(`name-${i}`);
              
              competitors.push({
                seed: parseInt(seedInput.value),
                name: nameInput.value || `Player ${i + 1}`
              });
            }
            
            debug(`Collected ${competitors.length} competitors`);
            
            // Validate competitors
            try {
              validateCompetitors(competitors);
            } catch (error) {
              debug(`Validation error: ${error.message}`);
              alert(error.message);
              return;
            }
            
            // Generate the bracket
            const showSeeds = showSeedsCheckbox.checked;
            const mermaidString = generateMermaidBracket(competitors, { showSeeds });
            
            debug("Generated Mermaid diagram");
            
            // Display the Mermaid syntax
            mermaidOutput.textContent = mermaidString;
            
            // Render the diagram
            diagramContainer.innerHTML = `<div class="mermaid">${mermaidString}</div>`;
            
            debug("Added diagram to DOM");
            
            // Force redraw of mermaid diagram
            mermaid.init(undefined, document.querySelector(".mermaid"));
            
            debug("Bracket generation complete");
          } catch (error) {
            debug(`Error generating bracket: ${error.message}`);
            alert(`Error generating bracket: ${error.message}`);
          }
        }
        
        // Generate a default bracket after a short delay
        setTimeout(function() {
          try {
            generateBracketUI();
            debug("Initial bracket rendered");
          } catch (error) {
            debug(`Failed to render initial bracket: ${error.message}`);
          }
        }, 1000);
      } catch (error) {
        console.error("Application initialization error:", error);
        alert(`Error initializing application: ${error.message}`);
      }
    }
    
    // Wait for DOM to load before initializing
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>
</body>
</html>